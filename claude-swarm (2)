#!/usr/bin/env bash
# claude-swarm: Spawn N AI CLI instances in git worktrees inside tmux
# Usage: claude-swarm [-n NUM] [-s SESSION] [-b BASE_BRANCH] [-t claude|gemini|codex]
set -euo pipefail

# ‚îÄ‚îÄ Defaults ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
NUM=4
SESSION="claude-swarm"
BASE_BRANCH=""          # empty = current branch
WORKTREE_PREFIX=".wt"   # worktrees live at .wt-1, .wt-2, ‚Ä¶
CLI_TYPE="claude"       # AI CLI to launch: claude, gemini, or codex
ADD_MODE=0              # 1 = append workers to existing session

# ‚îÄ‚îÄ Parse args ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
usage() {
  echo "Usage: $(basename "$0") [-n NUM] [-s SESSION] [-b BRANCH] [-t claude|gemini|codex] [-a]"
  echo "  -n NUM     Number of AI instances   (default: $NUM)"
  echo "  -s SESSION tmux session name        (default: $SESSION)"
  echo "  -b BRANCH  Base branch for worktrees (default: current branch)"
  echo "  -t TYPE    AI CLI to use: claude|gemini|codex (default: $CLI_TYPE)"
  echo "  -a         Add workers to an existing session instead of restarting"
  exit 1
}

while getopts ":n:s:b:t:ah" opt; do
  case $opt in
    n) NUM="$OPTARG" ;;
    s) SESSION="$OPTARG" ;;
    b) BASE_BRANCH="$OPTARG" ;;
    t) CLI_TYPE="$OPTARG" ;;
    a) ADD_MODE=1 ;;
    h) usage ;;
    *) echo "Unknown option: -$OPTARG"; usage ;;
  esac
done

# ‚îÄ‚îÄ Sanity checks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ! git rev-parse --git-dir &>/dev/null; then
  echo "‚ùå  Not inside a git repository." >&2; exit 1
fi

if ! command -v tmux &>/dev/null; then
  echo "‚ùå  tmux not found. Install it first." >&2; exit 1
fi

case "$CLI_TYPE" in
  claude|gemini|codex) ;;
  *) echo "‚ùå  Unknown CLI type: '$CLI_TYPE'. Use claude, gemini, or codex." >&2; exit 1 ;;
esac

if ! command -v "$CLI_TYPE" &>/dev/null; then
  echo "‚ùå  $CLI_TYPE not found. Install it first." >&2; exit 1
fi

re='^[1-9][0-9]*$'
if ! [[ $NUM =~ $re ]]; then
  echo "‚ùå  -n must be a positive integer." >&2; exit 1
fi

# ‚îÄ‚îÄ Resolve repo info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
REPO_ROOT=$(git rev-parse --show-toplevel)
[[ -z "$BASE_BRANCH" ]] && BASE_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse HEAD)

echo "üå≥  Repo   : $REPO_ROOT"
echo "üåø  Branch : $BASE_BRANCH"
echo "ü§ñ  Instances: $NUM  (CLI: $CLI_TYPE)"
echo "üì∫  Session : $SESSION"
echo ""

# ‚îÄ‚îÄ Add mode: append workers to an existing session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if [[ $ADD_MODE -eq 1 ]]; then
  if ! tmux has-session -t "$SESSION" 2>/dev/null; then
    echo "‚ùå  Session '$SESSION' not found. Start a swarm first (without -a)." >&2
    exit 1
  fi

  # Find the highest existing window index
  MAX_WIN=$(tmux list-windows -t "$SESSION" -F "#{window_index}" | sort -n | tail -1)
  START_IDX=$((MAX_WIN + 1))

  NEW_DIRS=()
  cleanup_new() {
    echo ""
    echo "üßπ  Cleaning up new worktrees‚Ä¶"
    for dir in "${NEW_DIRS[@]}"; do
      [[ -d "$dir" ]] && git worktree remove --force "$dir" 2>/dev/null || true
    done
    git worktree prune 2>/dev/null || true
  }
  trap cleanup_new EXIT

  for i in $(seq "$START_IDX" $((START_IDX + NUM - 1))); do
    WT_DIR="$REPO_ROOT/${WORKTREE_PREFIX}-${i}"
    WT_BRANCH="swarm/${BASE_BRANCH}/worker-${i}"
    [[ -d "$WT_DIR" ]] && git worktree remove --force "$WT_DIR" 2>/dev/null || true
    git branch -D "$WT_BRANCH" 2>/dev/null || true
    git worktree add -b "$WT_BRANCH" "$WT_DIR" "$BASE_BRANCH" -q
    NEW_DIRS+=("$WT_DIR")
    echo "‚úÖ  Worktree ${i} ‚Üí $WT_DIR  (branch: $WT_BRANCH)"
  done

  echo ""
  for i in $(seq "$START_IDX" $((START_IDX + NUM - 1))); do
    WT_DIR="$REPO_ROOT/${WORKTREE_PREFIX}-${i}"
    tmux new-window -t "$SESSION" -c "$WT_DIR" -n "worker-${i}"
    tmux send-keys -t "${SESSION}:${i}" "$CLI_TYPE" Enter
  done

  tmux select-window -t "${SESSION}:${START_IDX}"
  trap - EXIT

  echo "‚úÖ  Added $NUM ${CLI_TYPE} worker(s) to session '$SESSION'."
  echo "    Attach with: tmux attach -t '$SESSION'"
  exit 0
fi

# ‚îÄ‚îÄ Kill existing session (clean restart) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if tmux has-session -t "$SESSION" 2>/dev/null; then
  echo "‚ö†Ô∏è   Session '$SESSION' already exists ‚Äî killing it."
  tmux kill-session -t "$SESSION"
fi

# ‚îÄ‚îÄ Create worktrees ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
WORKTREE_DIRS=()

cleanup() {
  echo ""
  echo "üßπ  Cleaning up worktrees‚Ä¶"
  for dir in "${WORKTREE_DIRS[@]}"; do
    if [[ -d "$dir" ]]; then
      git worktree remove --force "$dir" 2>/dev/null || true
    fi
  done
  git worktree prune 2>/dev/null || true
}
trap cleanup EXIT

for i in $(seq 1 "$NUM"); do
  WT_DIR="$REPO_ROOT/${WORKTREE_PREFIX}-${i}"
  WT_BRANCH="swarm/${BASE_BRANCH}/worker-${i}"

  # Remove stale worktree/branch if they exist
  if [[ -d "$WT_DIR" ]]; then
    git worktree remove --force "$WT_DIR" 2>/dev/null || true
  fi
  git branch -D "$WT_BRANCH" 2>/dev/null || true

  git worktree add -b "$WT_BRANCH" "$WT_DIR" "$BASE_BRANCH" -q
  WORKTREE_DIRS+=("$WT_DIR")
  echo "‚úÖ  Worktree $i ‚Üí $WT_DIR  (branch: $WT_BRANCH)"
done

echo ""
echo "üöÄ  Launching tmux session‚Ä¶"

# ‚îÄ‚îÄ Detect optional tools ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
HAS_LAZYGIT=0
HAS_NVIM=0
command -v lazygit &>/dev/null && HAS_LAZYGIT=1
command -v nvim    &>/dev/null && HAS_NVIM=1

# ‚îÄ‚îÄ Build tmux session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
STATUS_BAR="#[bg=colour235,fg=colour245] Swarm: ${NUM} workers  \
#[fg=colour39]Alt+0#[fg=colour245]:hub  \
#[fg=colour39]Alt+1-9#[fg=colour245]:worker  \
#[fg=colour39]Ctrl+b+#[fg=colour245]:add  \
#[fg=colour39]Ctrl+b g#[fg=colour245]:git  \
#[fg=colour39]Ctrl+b e#[fg=colour245]:editor  \
#[fg=colour39]Ctrl+b d#[fg=colour245]:detach"

# Start session ‚Äî window 0 is the hub, workers begin at 1
tmux new-session -d -s "$SESSION" -c "$REPO_ROOT" -x 220 -y 50

# Configure status bar
tmux set-option -t "$SESSION" status on
tmux set-option -t "$SESSION" status-position bottom
tmux set-option -t "$SESSION" status-style "bg=colour235,fg=colour245"
tmux set-option -t "$SESSION" status-left "#[bg=colour33,fg=colour15,bold] ü§ñ SWARM (${CLI_TYPE}) #[bg=colour235] "
tmux set-option -t "$SESSION" status-left-length 30
tmux set-option -t "$SESSION" status-right "$STATUS_BAR"
tmux set-option -t "$SESSION" status-right-length 140
tmux set-option -t "$SESSION" window-status-format "#[fg=colour245] #I:#W "
tmux set-option -t "$SESSION" window-status-current-format "#[bg=colour33,fg=colour15,bold] #I:#W "

# ‚îÄ‚îÄ Window 0: Hub (nvim left | lazygit right) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
tmux rename-window -t "${SESSION}:0" "hub"

# Left pane: nvim (or a plain shell if nvim not available)
if [[ $HAS_NVIM -eq 1 ]]; then
  tmux send-keys -t "${SESSION}:0" "nvim ." Enter
else
  tmux send-keys -t "${SESSION}:0" "echo 'nvim not found ‚Äî install it for editor support'" Enter
fi

# Right pane: lazygit (40% width)
if [[ $HAS_LAZYGIT -eq 1 ]]; then
  tmux split-window -t "${SESSION}:0" -h -p 40 -c "$REPO_ROOT"
  tmux send-keys -t "${SESSION}:0.1" "lazygit" Enter
  # Pane border styling: highlight lazygit pane
  tmux set-option -t "$SESSION" pane-border-style "fg=colour238"
  tmux set-option -t "$SESSION" pane-active-border-style "fg=colour39"
  # Give nvim focus by default
  tmux select-pane -t "${SESSION}:0.0"
else
  echo "‚ö†Ô∏è   lazygit not found ‚Äî hub will open without git pane. Install lazygit for best experience."
fi

# ‚îÄ‚îÄ Keybindings for hub navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Ctrl+b g  ‚Üí jump to lazygit pane in hub
if [[ $HAS_LAZYGIT -eq 1 ]]; then
  tmux bind-key "g" run-shell "tmux select-window -t '${SESSION}:hub' && tmux select-pane -t '${SESSION}:0.1'"
fi
# Ctrl+b e  ‚Üí jump to nvim pane in hub
tmux bind-key "e" run-shell "tmux select-window -t '${SESSION}:hub' && tmux select-pane -t '${SESSION}:0.0'"

# Alt+0 ‚Üí hub window
tmux bind-key -n "M-0" select-window -t "${SESSION}:0" 2>/dev/null || true

# Alt+1-9 ‚Üí worker windows
for n in $(seq 1 9); do
  tmux bind-key -t "$SESSION" -n "M-${n}" select-window -t "${n}"  2>/dev/null || \
  tmux bind-key -n "M-${n}" select-window -t "${n}"
done

# Ctrl+b + ‚Üí add a new worker on the fly
ADD_ONE="idx=\$(tmux list-windows -t '${SESSION}' -F '#{window_index}' | sort -n | tail -1); \
idx=\$((idx+1)); \
wt='${REPO_ROOT}/${WORKTREE_PREFIX}-'\$idx; \
br='swarm/${BASE_BRANCH}/worker-'\$idx; \
git -C '${REPO_ROOT}' worktree add -b \"\$br\" \"\$wt\" '${BASE_BRANCH}' -q && \
tmux new-window -t '${SESSION}' -c \"\$wt\" -n \"worker-\$idx\" && \
tmux send-keys -t '${SESSION}':\$idx '${CLI_TYPE}' Enter && \
tmux display-message \"‚úÖ Worker \$idx added\""
tmux bind-key "+" run-shell "$ADD_ONE"

# ‚îÄ‚îÄ Worker windows (1-N) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
tmux new-window -t "$SESSION" -c "${WORKTREE_DIRS[0]}" -n "worker-1"
tmux send-keys -t "${SESSION}:1" "$CLI_TYPE" Enter

for i in $(seq 2 "$NUM"); do
  tmux new-window -t "$SESSION" -c "${WORKTREE_DIRS[$((i-1))]}" -n "worker-${i}"
  tmux send-keys -t "${SESSION}:${i}" "$CLI_TYPE" Enter
done

# Start on worker-1
tmux select-window -t "${SESSION}:1"

# ‚îÄ‚îÄ Attach ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo "‚úÖ  All $NUM ${CLI_TYPE} instances launched!"
echo "üìé  Attaching to session '$SESSION'‚Ä¶"
echo "    Detach anytime with: Ctrl+b  d"
echo ""

# Disable the EXIT trap while attached (user manually cleans up)
trap - EXIT

tmux attach-session -t "$SESSION"

# ‚îÄ‚îÄ Post-detach cleanup prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo ""
read -rp "üßπ  Remove worktrees and swarm branches? [Y/n] " answer
answer="${answer:-Y}"
if [[ "$answer" =~ ^[Yy]$ ]]; then
  for dir in "${WORKTREE_DIRS[@]}"; do
    branch=$(git -C "$dir" symbolic-ref --short HEAD 2>/dev/null || true)
    git worktree remove --force "$dir" 2>/dev/null || true
    [[ -n "$branch" ]] && git branch -D "$branch" 2>/dev/null || true
  done
  git worktree prune
  echo "‚úÖ  Cleaned up."
else
  echo "‚ÑπÔ∏è   Worktrees kept. Remove manually with: git worktree remove <path>"
fi
